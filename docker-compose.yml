version: '3.8'

# GlassTrax Bridge - Docker Compose
#
# The API runs inside the container and connects to a GlassTrax API Agent
# running on Windows for database access.
#
# USAGE:
#   # Basic (agent disabled - no GlassTrax access)
#   docker-compose up -d
#
#   # With agent (connects to Windows agent for GlassTrax access)
#   AGENT_URL=http://192.168.1.100:8001 AGENT_KEY=gta_xxx docker-compose up -d

services:
  glasstrax-bridge:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: glasstrax-bridge
    ports:
      # All traffic through nginx (portal, docs, API)
      - "3000:80"
    volumes:
      # Persist SQLite database
      - ./data:/app/data
      # Mount config for runtime changes
      - ./config.yaml:/app/config.yaml:ro
    environment:
      # GlassTrax API Agent Configuration
      # Set these to connect to the Windows agent for GlassTrax access
      - GLASSTRAX_AGENT_ENABLED=${AGENT_ENABLED:-false}
      - GLASSTRAX_AGENT_URL=${AGENT_URL:-http://host.docker.internal:8001}
      - GLASSTRAX_AGENT_KEY=${AGENT_KEY:-}
      - GLASSTRAX_AGENT_TIMEOUT=${AGENT_TIMEOUT:-30}
      # Timezone
      - TZ=${TZ:-America/New_York}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

# =============================================================================
# AGENT MODE SETUP
# =============================================================================
#
# To connect Docker to a Windows-hosted GlassTrax API Agent:
#
# 1. On Windows, start the agent:
#    .\agent\run_agent.bat
#    (Save the API key shown on first run)
#
# 2. Find your Windows IP:
#    ipconfig
#
# 3. Start Docker with agent configuration:
#    AGENT_ENABLED=true \
#    AGENT_URL=http://192.168.1.100:8001 \
#    AGENT_KEY=gta_your_key_here \
#    docker-compose up -d
#
# 4. Access:
#    - Portal:    http://localhost:3000
#    - Docs:      http://localhost:3000/docs
#    - API:       http://localhost:3000/api/v1
#    - Swagger:   http://localhost:3000/api/docs
#
# =============================================================================
