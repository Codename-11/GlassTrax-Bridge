name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Validate version consistency
  validate:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Verify VERSION file matches tag
        run: |
          FILE_VERSION=$(cat VERSION | tr -d '\r\n ')
          TAG_VERSION="${{ steps.version.outputs.version }}"
          echo "VERSION file: $FILE_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::VERSION file ($FILE_VERSION) doesn't match tag ($TAG_VERSION)"
            exit 1
          fi
          echo "Version validated: $TAG_VERSION"

  # API Tests (Python)
  test-api:
    name: API Tests
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run API tests
        run: pytest tests/ -v --tb=short

  # Agent Tests (Python)
  test-agent:
    name: Agent Tests
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pytest pytest-asyncio pytest-cov
          pip install fastapi uvicorn pydantic ruamel.yaml bcrypt httpx

      - name: Run Agent tests
        run: pytest agent/tests/ -v --tb=short

  # Portal Tests (TypeScript/React)
  test-portal:
    name: Portal Tests
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: portal/package-lock.json

      - name: Install dependencies
        run: cd portal && npm ci

      - name: Run tests
        run: cd portal && npm run test -- --run

  # Build Windows Agent installer
  build-agent:
    name: Build Agent Installer
    runs-on: windows-latest
    needs: [validate, test-api, test-agent, test-portal]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Build installer
        run: .\build_agent.ps1
        shell: powershell

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: agent-installer
          path: dist/*.exe
          if-no-files-found: error

  # Build Docker image
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [validate, test-api, test-agent, test-portal]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Stage 4: Check for release notes file (Claude-generated, committed to repo)
  release-notes:
    name: Check Release Notes
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      has_notes: ${{ steps.check.outputs.has_notes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for RELEASE_NOTES.md
        id: check
        run: |
          if [ -f "RELEASE_NOTES.md" ]; then
            echo "Found RELEASE_NOTES.md"
            echo "has_notes=true" >> $GITHUB_OUTPUT
          else
            echo "No RELEASE_NOTES.md found, will use GitHub auto-generated notes"
            echo "has_notes=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload release notes
        if: steps.check.outputs.has_notes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: RELEASE_NOTES.md
          retention-days: 7

  # Stage 5: Create GitHub Release (after build completes)
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate, build-agent, build-docker, release-notes]
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download installer artifact
        uses: actions/download-artifact@v4
        with:
          name: agent-installer
          path: dist/

      - name: Download release notes
        if: needs.release-notes.outputs.has_notes == 'true'
        uses: actions/download-artifact@v4
        with:
          name: release-notes
          path: .

      - name: Build release body
        env:
          VERSION: ${{ needs.validate.outputs.version }}
          HAS_NOTES: ${{ needs.release-notes.outputs.has_notes }}
          REPO: ${{ github.repository }}
        run: |
          # Start with Claude-generated notes if available (from RELEASE_NOTES.md)
          if [ "$HAS_NOTES" == "true" ] && [ -f RELEASE_NOTES.md ]; then
            cat RELEASE_NOTES.md > body.md
            echo "" >> body.md
            echo "---" >> body.md
            echo "" >> body.md
          fi

          # Add download section
          cat >> body.md << 'BODY'
          ## Downloads

          ### Windows Agent Installer
          Download `GlassTraxAPIAgent-${VERSION}-Setup.exe` below to install the GlassTrax API Agent on Windows.

          The agent provides ODBC access to GlassTrax for Docker deployments.

          ### Docker Image
          ```bash
          docker pull ghcr.io/${REPO}:${VERSION}
          ```

          Or use the latest tag:
          ```bash
          docker pull ghcr.io/${REPO}:latest
          ```

          ## Installation

          ### Agent (Windows)
          1. Download and run the installer
          2. Save the generated API key on first run
          3. Configure `agent_config.yaml` with your DSN

          ### Docker + Agent Mode
          ```bash
          AGENT_ENABLED=true \
          AGENT_URL=http://YOUR_WINDOWS_IP:8001 \
          AGENT_KEY=gta_your_key \
          docker-compose up -d
          ```

          ---
          See [documentation](https://codename-11.github.io/GlassTrax-Bridge/) for full setup instructions.
          BODY

          # Remove leading whitespace and expand variables
          sed -i 's/^          //' body.md
          sed -i "s/\${VERSION}/${VERSION}/g" body.md
          sed -i "s/\${REPO}/${REPO}/g" body.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: GlassTrax Bridge v${{ needs.validate.outputs.version }}
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
          generate_release_notes: ${{ needs.release-notes.outputs.has_notes != 'true' }}
          files: dist/*.exe
          body_path: body.md
