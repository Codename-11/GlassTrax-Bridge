name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Validate version consistency
  validate:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Verify VERSION file matches tag
        run: |
          FILE_VERSION=$(cat VERSION | tr -d '\r\n ')
          TAG_VERSION="${{ steps.version.outputs.version }}"
          echo "VERSION file: $FILE_VERSION"
          echo "Tag version: $TAG_VERSION"
          if [ "$FILE_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::VERSION file ($FILE_VERSION) doesn't match tag ($TAG_VERSION)"
            exit 1
          fi
          echo "Version validated: $TAG_VERSION"

  # API Tests (Python)
  test-api:
    name: API Tests
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run API tests
        run: pytest tests/ -v --tb=short

  # Agent Tests (Python)
  test-agent:
    name: Agent Tests
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pytest pytest-asyncio pytest-cov
          pip install fastapi uvicorn pydantic ruamel.yaml bcrypt httpx

      - name: Run Agent tests
        run: pytest agent/tests/ -v --tb=short

  # Portal Tests (TypeScript/React)
  test-portal:
    name: Portal Tests
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: portal/package-lock.json

      - name: Install dependencies
        run: cd portal && npm ci

      - name: Run tests
        run: cd portal && npm run test -- --run

  # Build Windows Agent installer
  build-agent:
    name: Build Agent Installer
    runs-on: windows-latest
    needs: [validate, test-api, test-agent, test-portal]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Build installer
        run: .\build_agent.ps1
        shell: powershell

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: agent-installer
          path: dist/*.exe
          if-no-files-found: error

  # Build Docker image
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [validate, test-api, test-agent, test-portal]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Create GitHub Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate, build-agent, build-docker]
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download installer artifact
        uses: actions/download-artifact@v4
        with:
          name: agent-installer
          path: dist/

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p')
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, using first commit"
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"

      - name: Generate release notes with Gemini
        id: gemini
        continue-on-error: true
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "No Gemini API key, skipping AI release notes"
            echo "gemini_success=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get raw commits for Gemini
          RAW_COMMITS=$(git log ${{ steps.prev_tag.outputs.prev_tag }}..HEAD --pretty=format:"%s" --no-merges)

          # Get diff stats
          DIFF_STATS=$(git diff --stat ${{ steps.prev_tag.outputs.prev_tag }}..HEAD | tail -1)

          # Build prompt
          PROMPT="Generate concise release notes for GlassTrax Bridge v${{ needs.validate.outputs.version }}.

          GlassTrax Bridge is a multi-tenant REST API platform for read-only access to GlassTrax ERP (Pervasive SQL) with a React admin portal and Windows agent for ODBC connectivity.

          Commits since last release (${{ steps.prev_tag.outputs.prev_tag }}):
          $RAW_COMMITS

          Changes: $DIFF_STATS

          Format the release notes as markdown with these sections (omit empty sections):
          - **New Features** - new functionality added
          - **Improvements** - enhancements to existing features
          - **Bug Fixes** - issues resolved
          - **Documentation** - doc updates
          - **Other Changes** - maintenance, refactoring, etc.

          Keep descriptions brief and user-focused. Use bullet points. Do not include commit hashes."

          # Call Gemini API
          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg prompt "$PROMPT" '{contents: [{parts: [{text: $prompt}]}]}')" 2>&1)

          # Extract text from response
          NOTES=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty' 2>/dev/null)

          if [ -n "$NOTES" ] && [ "$NOTES" != "null" ]; then
            echo "gemini_success=true" >> $GITHUB_OUTPUT
            # Save to file to preserve formatting
            echo "$NOTES" > release_notes.md
            echo "Release notes generated successfully"
          else
            echo "gemini_success=false" >> $GITHUB_OUTPUT
            echo "Failed to generate notes: $RESPONSE"
          fi

      - name: Build release body
        id: body
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          REPO="${{ github.repository }}"

          # Start with AI notes if available
          if [ "${{ steps.gemini.outputs.gemini_success }}" == "true" ] && [ -f release_notes.md ]; then
            cat release_notes.md > body.md
            echo "" >> body.md
            echo "---" >> body.md
            echo "" >> body.md
          fi

          # Add download section
          cat >> body.md << EOF
          ## Downloads

          ### Windows Agent Installer
          Download \`GlassTraxAPIAgent-${VERSION}-Setup.exe\` below to install the GlassTrax API Agent on Windows.

          The agent provides ODBC access to GlassTrax for Docker deployments.

          ### Docker Image
          \`\`\`bash
          docker pull ghcr.io/${REPO}:${VERSION}
          \`\`\`

          Or use the latest tag:
          \`\`\`bash
          docker pull ghcr.io/${REPO}:latest
          \`\`\`

          ## Installation

          ### Agent (Windows)
          1. Download and run the installer
          2. Save the generated API key on first run
          3. Configure \`agent_config.yaml\` with your DSN

          ### Docker + Agent Mode
          \`\`\`bash
          AGENT_ENABLED=true \\
          AGENT_URL=http://YOUR_WINDOWS_IP:8001 \\
          AGENT_KEY=gta_your_key \\
          docker-compose up -d
          \`\`\`

          ---
          See [documentation](https://codename-11.github.io/GlassTrax-Bridge/) for full setup instructions.
          EOF

          # Remove leading whitespace from heredoc
          sed -i 's/^          //' body.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: GlassTrax Bridge v${{ needs.validate.outputs.version }}
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
          generate_release_notes: ${{ steps.gemini.outputs.gemini_success != 'true' }}
          files: |
            dist/*.exe
          body_path: body.md
